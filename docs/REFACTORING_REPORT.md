# DAWG AI - Codebase Refactoring Report
**Generated by:** Tom (Instance 2 - Audio Engine)
**Date:** 2025-10-02
**Status:** Code Review Complete

## Executive Summary
The codebase has **53 widgets**, significant TypeScript errors, and opportunities for consolidation. Below are prioritized refactoring recommendations.

---

## 🔴 **Critical Issues (Fix Immediately)**

### 1. TypeScript Type Errors (Breaking Build)
**Files Affected:**
- `app/api/chat-openai/route.ts` (Lines 154, 239, 256, 257)
- `app/api/profile/route.ts` (Line 115)
- `app/api/voice/clone/route.ts` (Line 75)

**Problems:**
- OpenAI ChatCompletion tool types using `string` instead of literal `"function"`
- VocalRange `semitones` optional but type expects required
- Missing Prisma `voiceProfile` model

**Fix:**
```typescript
// BEFORE (app/api/chat-openai/route.ts:154)
{ type: string; function: { ... } }

// AFTER
{ type: "function" as const; function: { ... } }
```

**Priority:** P0 (Blocks type-checking)
**Estimate:** 1 hour

---

### 2. Widget Audio Effects Errors
**Files Affected:**
- `src/widgets/_examples/EffectsPanel.example.tsx` (Multiple lines)
- `src/widgets/EffectsPanel/EffectsPanel.tsx` (Lines 51, 54, 57)
- `src/widgets/MusicGenerator/MusicGenerator.tsx` (Line 146)
- `src/widgets/HarmonyGenerator/HarmonyGenerator.tsx` (Line 152)

**Problems:**
- Accessing private `.input`, `.feedback` properties on audio effect classes
- Invalid property names (`lowGain`, `midGain`, `highGain`, `mix`, `division`, `syncToBPM`)
- Type mismatches (`GainNode` assigned to `string | number`)

**Root Cause:** Audio effects API changed but widgets not updated.

**Fix:** Use public methods from `audioEffects.ts`:
```typescript
// Use getInputNode() instead of .input
eqProcessor.getInputNode()

// Fix EQ parameter names
eq.update({ low: -5, mid: 0, high: 3 }) // Not lowGain, midGain, highGain
```

**Priority:** P0 (Runtime errors)
**Estimate:** 2 hours

---

## 🟡 **High Priority (Performance & Architecture)**

### 3. Widget Duplication & Consolidation
**Current State:** 53 widgets with overlapping functionality

**Duplicates Identified:**
1. **Pitch Monitoring (3 widgets):**
   - `PitchMonitor.tsx` (full widget)
   - `CompactPitchMonitor.tsx` (compact version)
   - `LiveCoachingPanel.tsx` (includes pitch display)

   **Recommendation:** Create shared `<PitchDisplay>` component

2. **EQ Controls (2 widgets):**
   - `EQControls.tsx`
   - `CompactEQControls.tsx`

   **Recommendation:** Single `<EQControls compact={boolean}>` prop

3. **Voice/Profile (3 widgets):**
   - `VoiceProfileManager.tsx`
   - `CompactVoiceProfile.tsx`
   - `UserProfileCard.tsx`

   **Recommendation:** Merge into `<ProfileCard variant="full" | "compact" | "card">`

**Priority:** P1 (Reduces bundle size)
**Estimate:** 4 hours

---

### 4. Shared Hook Extraction
**Opportunities:**

#### A. Pitch Detection (Used in 5+ widgets)
**Current:** Each widget calls `usePitchDetection()` independently

**Widgets Using It:**
- LiveCoachingPanel
- PerformanceScorer
- WaveformAnnotations
- PitchMonitor
- CompactPitchMonitor

**Refactor:** Create global pitch context
```typescript
// src/contexts/PitchContext.tsx
export function PitchProvider({ children }) {
  const pitch = usePitchDetection({ ... });
  return <PitchContext.Provider value={pitch}>{children}</PitchContext.Provider>
}

// Widgets consume via context (no redundant audio processing)
const { currentPitch } = usePitch();
```

**Benefits:**
- Single AudioContext instance
- Reduced CPU usage (1 pitch detector vs 5)
- Consistent data across widgets

**Priority:** P1 (Performance)
**Estimate:** 3 hours

---

#### B. Recording Management (Duplicate Logic)
**Files with duplicate recording logic:**
- `useRecording.ts`
- `TrackItem.tsx`
- `AutoCompingTool.tsx`

**Refactor:** Centralize in `useRecording` hook, widgets consume store

**Priority:** P1 (DRY principle)
**Estimate:** 2 hours

---

### 5. Audio Effects Architecture
**Current Issue:** Effects scattered across multiple files

**Files:**
- `src/utils/audioEffects.ts` (Core classes)
- `src/core/useEffects.ts` (Hook)
- `src/widgets/EffectsPanel/EffectsPanel.tsx` (UI)
- `src/widgets/VocalEffectsPanel/VocalEffectsPanel.tsx` (Duplicate UI)

**Recommendation:** Unified effects architecture
```
src/audio/
├── effects/
│   ├── ParametricEQ.ts
│   ├── Compressor.ts
│   ├── Reverb.ts
│   ├── Delay.ts
│   └── index.ts (exports)
├── hooks/
│   └── useAudioEffects.ts (single hook)
└── types.ts
```

**Benefits:**
- Clear separation of concerns
- Easier testing
- Type-safe effect chains

**Priority:** P1 (Maintainability)
**Estimate:** 4 hours

---

## 🟢 **Medium Priority (Code Quality)**

### 6. Type Safety Improvements

#### A. Strict Null Checks
**Files with `possibly null` errors:**
- `PianoRoll.tsx` (Lines 116, 185, 190, 196, 198)
- `TrackItem.tsx` (Line 87)
- `WaveformDisplay.tsx` (Lines 77, 80)

**Fix:** Add null guards
```typescript
// BEFORE
const midi = currentPitch.midiNote; // Error: possibly null

// AFTER
const midi = currentPitch?.midiNote ?? 0;
```

**Priority:** P2 (Type safety)
**Estimate:** 1 hour

---

#### B. Event Bus Type Definitions
**Current:** Events use `any` in payload

**Recommendation:** Create strict event schemas
```typescript
// src/events/types.ts
export interface VoiceCommandEvent {
  event: 'voice.command';
  payload: {
    agent: 'alexis' | 'tom' | 'jerry' | 'karen';
    command: string;
    transcript: string;
  };
}

// Type-safe event publishing
eventBus.publish<VoiceCommandEvent>({ ... });
```

**Priority:** P2 (Type safety)
**Estimate:** 3 hours

---

### 7. Component Size Reduction
**Large Components (>300 lines):**
- `LiveCoachingPanel.tsx` (309 lines)
- `PerformanceScorer.tsx` (350 lines)
- `WaveformAnnotations.tsx` (335 lines)
- `ExerciseLibrary.tsx` (380 lines)

**Recommendation:** Extract sub-components
```typescript
// LiveCoachingPanel.tsx - BEFORE (309 lines)
export function LiveCoachingPanel() {
  // All logic + JSX in one file
}

// AFTER - Split into:
// - LiveCoachingPanel.tsx (100 lines - orchestration)
// - PitchDisplay.tsx (50 lines)
// - FeedbackList.tsx (70 lines)
// - BreathingReminder.tsx (40 lines)
```

**Priority:** P2 (Readability)
**Estimate:** 3 hours per widget (12 hours total)

---

### 8. CSS Module Consolidation
**Current:** Each widget has separate CSS module with duplicate styles

**Duplicate Styles Found:**
- `.container` (53 definitions)
- `.emptyState` (15 definitions)
- `.inactive` (8 definitions)

**Recommendation:** Create shared design system
```css
/* src/styles/widget-base.module.css */
.widgetContainer { /* Base container */ }
.widgetHeader { /* Shared header */ }
.emptyState { /* Shared empty state */ }

/* Widgets import and extend */
@import '@/src/styles/widget-base.module.css';

.customStyle {
  composes: widgetContainer;
  /* Widget-specific overrides */
}
```

**Priority:** P2 (Bundle size)
**Estimate:** 4 hours

---

## 🔵 **Low Priority (Nice to Have)**

### 9. Testing Infrastructure
**Current:** No tests found

**Recommendation:**
```bash
# Add test files
src/widgets/__tests__/
src/core/__tests__/
src/utils/__tests__/

# Test framework: Vitest + React Testing Library
npm install -D vitest @testing-library/react
```

**Priority:** P3 (Quality)
**Estimate:** Ongoing

---

### 10. Documentation Cleanup
**Issues:**
- Inconsistent JSDoc comments
- Missing prop documentation
- No widget usage examples

**Recommendation:**
```typescript
/**
 * LiveCoachingPanel - Real-time vocal coaching feedback
 *
 * @example
 * ```tsx
 * <LiveCoachingPanel
 *   trackId="track-1"
 *   isRecording={true}
 *   bpm={120}
 * />
 * ```
 *
 * @param trackId - Optional track identifier
 * @param isRecording - Whether recording is active
 * @param bpm - Tempo for breathing reminders (default: 120)
 */
```

**Priority:** P3 (Developer experience)
**Estimate:** 2 hours

---

## 📊 **Metrics Summary**

| Category | Count | Issues |
|----------|-------|--------|
| **Total Files** | ~150 | - |
| **Widgets** | 53 | Duplication |
| **TypeScript Errors** | 47+ | Type mismatches |
| **Duplicate Code** | High | 3+ widget duplicates |
| **Test Coverage** | 0% | No tests |

---

## 🎯 **Recommended Action Plan**

### Sprint 1: Critical Fixes (1 week)
1. ✅ Fix TypeScript type errors
2. ✅ Fix audio effects API usage
3. ✅ Add null guards to prevent runtime errors

### Sprint 2: Architecture (2 weeks)
4. ✅ Consolidate duplicate widgets
5. ✅ Extract shared PitchContext
6. ✅ Refactor audio effects architecture

### Sprint 3: Quality (1 week)
7. ✅ Add event bus type safety
8. ✅ Extract large component sub-components
9. ✅ Consolidate CSS modules

### Sprint 4: Polish (Ongoing)
10. ✅ Add tests
11. ✅ Improve documentation

---

## 💡 **Quick Wins (< 2 hours each)**

1. **Fix OpenAI type errors** → Use `as const` for literal types
2. **Add null guards** → Prevent runtime crashes
3. **Merge compact widgets** → Use `compact` prop instead
4. **Extract shared CSS** → Create `widget-base.module.css`
5. **Document top 10 widgets** → Add JSDoc comments

---

## 🔧 **Tools & Automation**

### Recommended Setup
```bash
# Linting
npm install -D eslint-plugin-react-hooks
npm install -D @typescript-eslint/eslint-plugin

# Formatting
npm install -D prettier

# Type checking in CI
npm run type-check

# Bundle analysis
npm install -D @next/bundle-analyzer
```

---

## 📝 **Notes for Other Instances**

**@alexis (Planner):**
- Created tasks for critical fixes
- Estimated refactoring at 12-day sprint

**@jerry (Backend):**
- API type errors need immediate attention
- Consider adding Prisma schema for `voiceProfile`

**@karen (Profile Manager):**
- VocalRange type needs `semitones` to be required or properly optional
- User profile API has type mismatch

**@conductor:**
- Refactoring will improve protocol compliance
- Event bus types should match schemas in `/docs/events/`

---

**Generated by Tom (instance-2-audio-engine)**
**Next Review:** 2025-10-09
